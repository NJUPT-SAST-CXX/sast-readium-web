# Internationalization

SAST Readium supports multiple languages using [react-i18next](https://react.i18next.com/), providing a seamless multilingual experience.

## Supported Languages

| Language             | Code | Status   |
| -------------------- | ---- | -------- |
| English              | `en` | Complete |
| Chinese (Simplified) | `zh` | Complete |

## Configuration

### i18next Setup

The i18n configuration is in `lib/i18n.ts`:

```typescript
import i18n from "i18next";
import { initReactI18next } from "react-i18next";
import LanguageDetector from "i18next-browser-languagedetector";
import resourcesToBackend from "i18next-resources-to-backend";

i18n
  .use(LanguageDetector)
  .use(initReactI18next)
  .use(
    resourcesToBackend((language: string, namespace: string) => {
      // Map language variants to base language
      let lang = language;
      if (language.startsWith("zh")) lang = "zh";
      if (language.startsWith("en")) lang = "en";

      return import(`../locales/${lang}/${namespace}.json`);
    })
  )
  .init({
    fallbackLng: "en",
    supportedLngs: ["en", "zh"],
    defaultNS: "translation",
    interpolation: {
      escapeValue: false, // React already escapes
    },
    detection: {
      order: ["localStorage", "navigator"],
      caches: ["localStorage"],
    },
  });

export default i18n;
```

### Language Detection

The app automatically detects the user's preferred language:

1. Check `localStorage` for saved preference
2. Fall back to browser's `navigator.language`
3. Default to English if no match

## Translation Files

### File Structure

```text
locales/
├── en/
│   └── translation.json    # English translations
└── zh/
    └── translation.json    # Chinese translations
```

### Translation Format

Translations are organized by feature namespace:

```json
{
  "common": {
    "open": "Open",
    "save": "Save",
    "cancel": "Cancel",
    "close": "Close",
    "delete": "Delete",
    "edit": "Edit",
    "confirm": "Confirm"
  },
  "pdf": {
    "page": "Page",
    "of": "of",
    "zoom": "Zoom",
    "fit_width": "Fit Width",
    "fit_page": "Fit Page",
    "rotate": "Rotate",
    "search": "Search",
    "no_results": "No results found"
  },
  "annotations": {
    "highlight": "Highlight",
    "comment": "Comment",
    "drawing": "Drawing",
    "undo": "Undo",
    "redo": "Redo"
  },
  "ai": {
    "send": "Send",
    "thinking": "Thinking...",
    "error": "An error occurred",
    "clear_chat": "Clear Chat"
  },
  "settings": {
    "title": "Settings",
    "theme": "Theme",
    "language": "Language",
    "dark_mode": "Dark Mode"
  }
}
```

## Using Translations

### In Components

Use the `useTranslation` hook:

```tsx
import { useTranslation } from "react-i18next";

function SaveButton() {
  const { t } = useTranslation();

  return <button>{t("common.save")}</button>;
}
```

### With Interpolation

Pass variables to translations:

```json
{
  "pdf": {
    "page_info": "Page {{current}} of {{total}}"
  }
}
```

```tsx
function PageInfo({ current, total }: { current: number; total: number }) {
  const { t } = useTranslation();

  return <span>{t("pdf.page_info", { current, total })}</span>;
}
```

### Pluralization

Handle singular/plural forms:

```json
{
  "annotations": {
    "count_one": "{{count}} annotation",
    "count_other": "{{count}} annotations"
  }
}
```

```tsx
function AnnotationCount({ count }: { count: number }) {
  const { t } = useTranslation();

  return <span>{t("annotations.count", { count })}</span>;
}
```

### Nested Keys

Access deeply nested translations:

```json
{
  "settings": {
    "appearance": {
      "theme": {
        "light": "Light",
        "dark": "Dark",
        "system": "System"
      }
    }
  }
}
```

```tsx
const { t } = useTranslation();
t("settings.appearance.theme.dark"); // "Dark"
```

## Language Switching

### Language Switcher Component

```tsx
import { useTranslation } from "react-i18next";

function LanguageSwitcher() {
  const { i18n } = useTranslation();

  const languages = [
    { code: "en", name: "English" },
    { code: "zh", name: "中文" },
  ];

  return (
    <select
      value={i18n.language}
      onChange={(e) => i18n.changeLanguage(e.target.value)}
    >
      {languages.map((lang) => (
        <option key={lang.code} value={lang.code}>
          {lang.name}
        </option>
      ))}
    </select>
  );
}
```

### Programmatic Switching

```typescript
import { useTranslation } from "react-i18next";

function useLanguage() {
  const { i18n } = useTranslation();

  const changeLanguage = (lang: string) => {
    i18n.changeLanguage(lang);
    // Language is automatically saved to localStorage
  };

  return {
    currentLanguage: i18n.language,
    changeLanguage,
  };
}
```

## Adding New Languages

### 1. Create Translation File

Create `locales/{lang}/translation.json`:

```json
{
  "common": {
    "open": "Ouvrir",
    "save": "Enregistrer"
  }
}
```

### 2. Update i18n Config

Add the new language to `supportedLngs`:

```typescript
i18n.init({
  supportedLngs: ["en", "zh", "fr"], // Add new language
  // ...
});
```

### 3. Update Language Switcher

Add the new language option:

```typescript
const languages = [
  { code: "en", name: "English" },
  { code: "zh", name: "中文" },
  { code: "fr", name: "Français" }, // New language
];
```

## Best Practices

### 1. Use Namespaces for Large Apps

Split translations by feature:

```text
locales/en/
├── common.json
├── pdf.json
├── ai.json
└── settings.json
```

```typescript
const { t } = useTranslation("pdf");
t("zoom"); // From pdf.json
```

### 2. Avoid Hardcoded Strings

```tsx
// ✅ Good
<button>{t("common.save")}</button>

// ❌ Bad
<button>Save</button>
```

### 3. Use Context for Ambiguous Terms

```json
{
  "common": {
    "open_file": "Open",
    "open_status": "Open"
  }
}
```

### 4. Handle Missing Translations

```typescript
i18n.init({
  saveMissing: true, // Log missing keys in development
  missingKeyHandler: (lng, ns, key) => {
    console.warn(`Missing translation: ${lng}/${ns}/${key}`);
  },
});
```

### 5. Format Dates and Numbers

Use i18next's formatting:

```json
{
  "date": {
    "created": "Created on {{date, datetime}}"
  }
}
```

```tsx
t("date.created", { date: new Date() });
```

## Testing Translations

### Unit Tests

```typescript
import { render, screen } from "@testing-library/react";
import { I18nextProvider } from "react-i18next";
import i18n from "@/lib/i18n";

test("displays translated text", () => {
  render(
    <I18nextProvider i18n={i18n}>
      <SaveButton />
    </I18nextProvider>
  );

  expect(screen.getByText("Save")).toBeInTheDocument();
});
```

### Testing Different Languages

```typescript
beforeEach(() => {
  i18n.changeLanguage("zh");
});

test("displays Chinese text", () => {
  render(
    <I18nextProvider i18n={i18n}>
      <SaveButton />
    </I18nextProvider>
  );

  expect(screen.getByText("保存")).toBeInTheDocument();
});
```
